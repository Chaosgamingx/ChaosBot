"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Facebook=void 0;const node_fetch_1=__importDefault(require("node-fetch")),jsdom_1=require("jsdom"),https_1=__importDefault(require("https")),http_1=__importDefault(require("http")),REGEX=/(https?:\/\/)(www\.|m\.)?(facebook|fb).com\/.*\/videos\/.*/;class Facebook{constructor(){throw new Error(`The ${this.constructor.name} class may not be instantiated!`)}static validateURL(url){return!(!url||"string"!=typeof url)&&REGEX.test(url)}static get Regex(){return REGEX}static download(url){return new Promise((resolve,reject)=>__awaiter(this,void 0,void 0,(function*(){Facebook.validateURL(url)||reject(new Error("Invalid url."));const info=yield Facebook.getInfo(url);if(!info||!info.streamURL)return reject(new Error("video not found"));const link=info.streamURL,req=link.startsWith("http://")?http_1.default:https_1.default;req.get(link,res=>{resolve(res)})})))}static getInfo(url){return __awaiter(this,void 0,void 0,(function*(){if(!Facebook.validateURL(url))throw new Error("Invalid url.");try{const html=yield Facebook._parseHTML(url),document=new jsdom_1.JSDOM(html).window.document,rawdata=document.querySelector('script[type="application/ld+json"]').innerHTML,json=JSON.parse(rawdata),obj={name:json.name,title:document.querySelector('meta[property="og:title"]').attributes.item(1).value,description:json.description,rawVideo:json.contentUrl,thumbnail:json.thumbnailUrl,uploadedAt:new Date(json.uploadDate),duration:Facebook.parseTime(json.duration),interactionCount:json.interactionCount,streamURL:json.url,publishedAt:new Date(json.datePublished),width:json.width,height:json.height,live:!!json.publication[0].isLiveBroadcast,nsfw:!json.isFamilyFriendly,genre:json.genre,keywords:json.keywords?json.keywords.split(", "):[],comments:json.commentCount,size:json.contentSize,quality:json.videoQuality,author:{type:json.author["@type"],name:json.author.name,url:json.author.url},publisher:{type:json.publisher["@type"],name:json.publisher.name,url:json.publisher.url,avatar:json.publisher.logo.url},url:html.split('",page_uri:"')[1].split('",')[0],shares:html.split(",share_count:{")[1].split("},")[0].split(":")[1],views:html.split(",video_view_count:")[1].split(",")[0]};return obj}catch(_a){return null}}))}static parseTime(duration){if("string"!=typeof duration)return duration;let a=duration.match(/\d+/g);return duration.indexOf("M")>=0&&-1===duration.indexOf("H")&&-1===duration.indexOf("S")&&(a=[0,a[0],0]),duration.indexOf("H")>=0&&-1===duration.indexOf("M")&&(a=[a[0],0,a[1]]),duration.indexOf("H")>=0&&-1===duration.indexOf("M")&&-1===duration.indexOf("S")&&(a=[a[0],0,0]),duration=0,3===a.length&&(duration+=3600*parseInt(a[0]),duration+=60*parseInt(a[1]),duration+=parseInt(a[2])),2===a.length&&(duration+=60*parseInt(a[0]),duration+=parseInt(a[1])),1===a.length&&(duration+=parseInt(a[0])),duration}static _parseHTML(url){return __awaiter(this,void 0,void 0,(function*(){const res=yield node_fetch_1.default(url.replace("/m.","/"));return yield res.text()}))}}exports.Facebook=Facebook;